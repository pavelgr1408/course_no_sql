# –û—Ç—á—ë—Ç: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ MongoDB

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏](#1-–æ–ø–∏—Å–∞–Ω–∏–µ-–∑–∞–¥–∞—á–∏)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞](#2-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∫–ª–∞—Å—Ç–µ—Ä–∞)
3. [–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ Docker](#3-—Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ-–∫–ª–∞—Å—Ç–µ—Ä–∞-–≤-docker)
4. [–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∫–ª–∞—Å—Ç–µ—Ä–∞](#4-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤-–∫–ª–∞—Å—Ç–µ—Ä–∞)
5. [–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏](#5-—Å–æ–∑–¥–∞–Ω–∏–µ-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö-–∏-–Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ-—Ç–µ—Å—Ç–æ–≤—ã–º–∏-–¥–∞–Ω–Ω—ã–º–∏)
6. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏](#6-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-—à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è-–∏-–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏)
7. [–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö](#7-–∞–Ω–∞–ª–∏–∑-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è-–¥–∞–Ω–Ω—ã—Ö)
8. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏](#8-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-–æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏)
9. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏](#9-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏-–∏-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
10. [–í—ã–≤–æ–¥—ã](#10-–≤—ã–≤–æ–¥—ã)

---

## 1. –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

**–¶–µ–ª—å —Ä–∞–±–æ—Ç—ã:** –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä MongoDB –∏–∑ —Ç—Ä—ë—Ö —à–∞—Ä–¥–æ–≤, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å (–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤), –∞ —Ç–∞–∫–∂–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∫–ª–∞—Å—Ç–µ—Ä–∞.

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**

- MongoDB 7.0
- Docker / Docker Compose
- mongosh (MongoDB Shell)
- MongoDB Compass (GUI-–∫–ª–∏–µ–Ω—Ç)

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞

–ö–ª–∞—Å—Ç–µ—Ä —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç –≤ Docker –∏ –≤–∫–ª—é—á–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ | –†–æ–ª—å | –ü–æ—Ä—Ç—ã (host) |
|---|---|---|---|
| Config Server Replica Set | 3 | –•—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞ | 40001‚Äì40003 |
| Shard 1 Replica Set | 3 | –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—à–∞—Ä–¥ 1) | 40011‚Äì40013 |
| Shard 2 Replica Set | 3 | –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—à–∞—Ä–¥ 2) | 40021‚Äì40023 |
| Shard 3 Replica Set | 3 | –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—à–∞—Ä–¥ 3) | 40031‚Äì40033 |
| Mongos Router | 1 | –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ | 27017 |

**–ò—Ç–æ–≥–æ:** 13 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã—Ö –≤ –µ–¥–∏–Ω—É—é Docker-—Å–µ—Ç—å `mongo-cluster` (bridge).

---

## 3. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ Docker

### 3.1. Docker Compose —Ñ–∞–π–ª

–°–æ–∑–¥–∞–Ω `docker-compose.yml`, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–ª–∞—Å—Ç–µ—Ä–∞:

```yaml
version: '3.8'

services:
  # ============================================
  # Config Server Replica Set (3 –∏–Ω—Å—Ç–∞–Ω—Å–∞)
  # ============================================
  mongo-configsvr-1:
    image: mongo:7.0
    container_name: mongo-configsvr-1
    command: mongod --configsvr --replSet config-replica-set --port 27019 --bind_ip_all
    ports:
      - "40001:27019"
    volumes:
      - configsvr1_data:/data/db
    networks:
      - mongo-cluster

  mongo-configsvr-2:
    image: mongo:7.0
    container_name: mongo-configsvr-2
    command: mongod --configsvr --replSet config-replica-set --port 27019 --bind_ip_all
    ports:
      - "40002:27019"
    volumes:
      - configsvr2_data:/data/db
    networks:
      - mongo-cluster

  mongo-configsvr-3:
    image: mongo:7.0
    container_name: mongo-configsvr-3
    command: mongod --configsvr --replSet config-replica-set --port 27019 --bind_ip_all
    ports:
      - "40003:27019"
    volumes:
      - configsvr3_data:/data/db
    networks:
      - mongo-cluster

  # ============================================
  # Shard 1 Replica Set (3 –∏–Ω—Å—Ç–∞–Ω—Å–∞)
  # ============================================
  mongo-shard-1-rs-1:
    image: mongo:7.0
    container_name: mongo-shard-1-rs-1
    command: mongod --shardsvr --replSet shard-replica-set-1 --port 27018 --bind_ip_all
    ports:
      - "40011:27018"
    volumes:
      - shard1_rs1_data:/data/db
    networks:
      - mongo-cluster

  mongo-shard-1-rs-2:
    image: mongo:7.0
    container_name: mongo-shard-1-rs-2
    command: mongod --shardsvr --replSet shard-replica-set-1 --port 27018 --bind_ip_all
    ports:
      - "40012:27018"
    volumes:
      - shard1_rs2_data:/data/db
    networks:
      - mongo-cluster

  mongo-shard-1-rs-3:
    image: mongo:7.0
    container_name: mongo-shard-1-rs-3
    command: mongod --shardsvr --replSet shard-replica-set-1 --port 27018 --bind_ip_all
    ports:
      - "40013:27018"
    volumes:
      - shard1_rs3_data:/data/db
    networks:
      - mongo-cluster

  # ============================================
  # Shard 2 Replica Set (3 –∏–Ω—Å—Ç–∞–Ω—Å–∞)
  # ============================================
  mongo-shard-2-rs-1:
    image: mongo:7.0
    container_name: mongo-shard-2-rs-1
    command: mongod --shardsvr --replSet shard-replica-set-2 --port 27018 --bind_ip_all
    ports:
      - "40021:27018"
    volumes:
      - shard2_rs1_data:/data/db
    networks:
      - mongo-cluster

  mongo-shard-2-rs-2:
    image: mongo:7.0
    container_name: mongo-shard-2-rs-2
    command: mongod --shardsvr --replSet shard-replica-set-2 --port 27018 --bind_ip_all
    ports:
      - "40022:27018"
    volumes:
      - shard2_rs2_data:/data/db
    networks:
      - mongo-cluster

  mongo-shard-2-rs-3:
    image: mongo:7.0
    container_name: mongo-shard-2-rs-3
    command: mongod --shardsvr --replSet shard-replica-set-2 --port 27018 --bind_ip_all
    ports:
      - "40023:27018"
    volumes:
      - shard2_rs3_data:/data/db
    networks:
      - mongo-cluster

  # ============================================
  # Shard 3 Replica Set (3 –∏–Ω—Å—Ç–∞–Ω—Å–∞)
  # ============================================
  mongo-shard-3-rs-1:
    image: mongo:7.0
    container_name: mongo-shard-3-rs-1
    command: mongod --shardsvr --replSet shard-replica-set-3 --port 27018 --bind_ip_all
    ports:
      - "40031:27018"
    volumes:
      - shard3_rs1_data:/data/db
    networks:
      - mongo-cluster

  mongo-shard-3-rs-2:
    image: mongo:7.0
    container_name: mongo-shard-3-rs-2
    command: mongod --shardsvr --replSet shard-replica-set-3 --port 27018 --bind_ip_all
    ports:
      - "40032:27018"
    volumes:
      - shard3_rs2_data:/data/db
    networks:
      - mongo-cluster

  mongo-shard-3-rs-3:
    image: mongo:7.0
    container_name: mongo-shard-3-rs-3
    command: mongod --shardsvr --replSet shard-replica-set-3 --port 27018 --bind_ip_all
    ports:
      - "40033:27018"
    volumes:
      - shard3_rs3_data:/data/db
    networks:
      - mongo-cluster

  # ============================================
  # Mongos Router
  # ============================================
  mongos:
    image: mongo:7.0
    container_name: mongos-router
    command: >
      mongos --configdb config-replica-set/mongo-configsvr-1:27019,mongo-configsvr-2:27019,mongo-configsvr-3:27019
      --bind_ip_all --port 27017
    ports:
      - "27017:27017"
    depends_on:
      - mongo-configsvr-1
      - mongo-configsvr-2
      - mongo-configsvr-3
    networks:
      - mongo-cluster

volumes:
  configsvr1_data:
  configsvr2_data:
  configsvr3_data:
  shard1_rs1_data:
  shard1_rs2_data:
  shard1_rs3_data:
  shard2_rs1_data:
  shard2_rs2_data:
  shard2_rs3_data:
  shard3_rs1_data:
  shard3_rs2_data:
  shard3_rs3_data:

networks:
  mongo-cluster:
    driver: bridge
```

### 3.2. –ó–∞–ø—É—Å–∫ –∫–ª–∞—Å—Ç–µ—Ä–∞

–í—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:

```bash
docker compose up -d
```

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:

```bash
docker ps
```

> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≤—Å–µ 13 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã –∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ `Up`.

---

## 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∫–ª–∞—Å—Ç–µ—Ä–∞

### 4.1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Config Server Replica Set

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø–µ—Ä–≤–æ–º—É config-—Å–µ—Ä–≤–µ—Ä—É:

```bash
docker exec -it mongo-configsvr-1 mongosh --port 27019
```

–í—ã–ø–æ–ª–Ω–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Ä–µ–ø–ª–∏–∫–∞-—Å–µ—Ç–∞:

```javascript
rs.initiate({
  "_id": "config-replica-set",
  "configsvr": true,
  members: [
    { "_id": 0, "host": "mongo-configsvr-1:27019" },
    { "_id": 1, "host": "mongo-configsvr-2:27019" },
    { "_id": 2, "host": "mongo-configsvr-3:27019" }
  ]
})
```

> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** `{ ok: 1 }` ‚Äî Config Server Replica Set –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ.

### 4.2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Replica Set –∫–∞–∂–¥–æ–≥–æ —à–∞—Ä–¥–∞

**Shard 1:**

```bash
docker exec -it mongo-shard-1-rs-1 mongosh --port 27018
```

```javascript
rs.initiate({
  "_id": "shard-replica-set-1",
  members: [
    { "_id": 0, "host": "mongo-shard-1-rs-1:27018" },
    { "_id": 1, "host": "mongo-shard-1-rs-2:27018" },
    { "_id": 2, "host": "mongo-shard-1-rs-3:27018" }
  ]
})
```

**Shard 2:**

```bash
docker exec -it mongo-shard-2-rs-1 mongosh --port 27018
```

```javascript
rs.initiate({
  "_id": "shard-replica-set-2",
  members: [
    { "_id": 0, "host": "mongo-shard-2-rs-1:27018" },
    { "_id": 1, "host": "mongo-shard-2-rs-2:27018" },
    { "_id": 2, "host": "mongo-shard-2-rs-3:27018" }
  ]
})
```

**Shard 3:**

```bash
docker exec -it mongo-shard-3-rs-1 mongosh --port 27018
```

```javascript
rs.initiate({
  "_id": "shard-replica-set-3",
  members: [
    { "_id": 0, "host": "mongo-shard-3-rs-1:27018" },
    { "_id": 1, "host": "mongo-shard-3-rs-2:27018" },
    { "_id": 2, "host": "mongo-shard-3-rs-3:27018" }
  ]
})
```

> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≤—Å–µ —Ç—Ä–∏ Replica Set –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ (`{ ok: 1 }`).

### 4.3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —à–∞—Ä–¥–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä —á–µ—Ä–µ–∑ Mongos Router

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–æ—É—Ç–µ—Ä—É:

```bash
docker exec -it mongos-router mongosh
```

–í—ã–ø–æ–ª–Ω–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞—Ä–¥–∞:

```javascript
sh.addShard("shard-replica-set-1/mongo-shard-1-rs-1:27018,mongo-shard-1-rs-2:27018,mongo-shard-1-rs-3:27018")
sh.addShard("shard-replica-set-2/mongo-shard-2-rs-1:27018,mongo-shard-2-rs-2:27018,mongo-shard-2-rs-3:27018")
sh.addShard("shard-replica-set-3/mongo-shard-3-rs-1:27018,mongo-shard-3-rs-2:27018,mongo-shard-3-rs-3:27018")
```

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞:

```javascript
sh.status()
```

> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≤—Å–µ —Ç—Ä–∏ —à–∞—Ä–¥–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä. –°—Ç–∞—Ç—É—Å `state: 1` —É –∫–∞–∂–¥–æ–≥–æ —à–∞—Ä–¥–∞.

### 4.4. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É —á–µ—Ä–µ–∑ MongoDB Compass

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ GUI-–∫–ª–∏–µ–Ω—Ç MongoDB Compass –ø–æ –∞–¥—Ä–µ—Å—É `mongodb://localhost:27017`.

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É —á–µ—Ä–µ–∑ MongoDB Compass*
>
![2_1.png](../../screen/2_1.png)

---

## 5. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

### 5.1. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```javascript
use shopdb
```

–í–∫–ª—é—á–µ–Ω–∏–µ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:

```javascript
sh.enableSharding("shopdb")
```

### 5.2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ **100 000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** (–∑–∞–∫–∞–∑–æ–≤) –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `tickets`:

```javascript
print("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...");

var cities = ["–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–ö–∞–∑–∞–Ω—å"];
var products = ["–ù–æ—É—Ç–±—É–∫", "–°–º–∞—Ä—Ç—Ñ–æ–Ω", "–ü–ª–∞–Ω—à–µ—Ç", "–ù–∞—É—à–Ω–∏–∫–∏", "–ú–æ–Ω–∏—Ç–æ—Ä"];
var statuses = ["pending", "processing", "shipped", "delivered"];

var batch = [];
var batchSize = 1000;

for (var i = 1; i <= 100000; i++) {
    batch.push({
        ticket_id: i,
        user_id: Math.floor(Math.random() * 10000) + 1,
        amount: Math.floor(Math.random() * 150000) + 1000,
        product: products[Math.floor(Math.random() * products.length)],
        city: cities[Math.floor(Math.random() * cities.length)],
        status: statuses[Math.floor(Math.random() * statuses.length)],
        created_at: new Date(Date.now() - Math.floor(Math.random() * 365 * 24 * 60 * 60 * 1000))
    });

    if (batch.length === batchSize) {
        db.tickets.insertMany(batch);
        batch = [];
        if (i % 10000 === 0) {
            print("–°–æ–∑–¥–∞–Ω–æ: " + i);
        }
    }
}

if (batch.length > 0) {
    db.tickets.insertMany(batch);
}

print("–°–æ–∑–¥–∞–Ω–æ 100,000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤");
print("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: " + db.tickets.countDocuments());
```

> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `shopdb.tickets` —Å–æ–∑–¥–∞–Ω–æ 100 000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

---

## 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏

### 6.1. –í—ã–±–æ—Ä –∫–ª—é—á–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è

–ü–µ—Ä–µ–¥ –≤—ã–±–æ—Ä–æ–º –∫–ª—é—á–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–ª—é `user_id`:

```javascript
db.tickets.aggregate([
  { $group: { _id: "$user_id", count: { $sum: 1 } } },
  { $sort: { count: -1 } },
  { $limit: 5 }
])
```

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ user_id*
>
![02_user_id_distribution.png](../../screen/02_user_id_distribution.png)

**–†–µ—à–µ–Ω–∏–µ:** –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∫–ª—é—á–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–±—Ä–∞–Ω **—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ –ø–æ–ª—é `user_id`** (`hashed`). –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –≤ —Ä–µ–∞–ª—å–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ö–µ—à—É –∫–ª–∏–µ–Ω—Ç–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ —à–∞—Ä–¥–∞–º –∏ –∏—Å–∫–ª—é—á–∞–µ—Ç ¬´–≥–æ—Ä—è—á–∏–µ —Ç–æ—á–∫–∏¬ª.

–í—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏:

```javascript
sh.shardCollection("shopdb.tickets", { user_id: "hashed" })
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```json
{
  "collectionsharded": "shopdb.tickets",
  "ok": 1
}
```

### 6.2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —á–∞–Ω–∫–æ–≤

–î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –¥–∞—Ç–∞—Å–µ—Ç–µ —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ —É–º–µ–Ω—å—à–µ–Ω —Å 128 –ú–ë (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) –¥–æ 1 –ú–ë:

```javascript
use config

db.settings.updateOne(
  { _id: "chunksize" },
  { $set: { _id: "chunksize", value: 1 } },
  { upsert: true }
)
```

–ü—Ä–æ–≤–µ—Ä–∫–∞:

```javascript
db.settings.findOne({ _id: "chunksize" })
```

> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** `{ _id: "chunksize", value: 1 }` ‚Äî —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ 1 –ú–ë.

### 6.3. –†—É—á–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ (split)

–î–ª—è –±–æ–ª–µ–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä—É—á–Ω–æ–≥–æ —Ä–∞–∑–±–∏–µ–Ω–∏—è —á–∞–Ω–∫–æ–≤:

```javascript
sh.splitFind("shopdb.tickets", { user_id: 5000 })
sh.splitFind("shopdb.tickets", { user_id: 2000 })
sh.splitFind("shopdb.tickets", { user_id: 3000 })
sh.splitFind("shopdb.tickets", { user_id: 7000 })
sh.splitFind("shopdb.tickets", { user_id: 8000 })
```

> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –∫–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ `{ ok: 1 }`. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å —Å 9 –¥–æ 14.

### 6.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∞

```javascript
sh.balancerCollectionStatus("shopdb.tickets")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```json
{
  "chunkSize": 1,
  "balancerCompliant": true,
  "ok": 1
}
```

–°—Ç–∞—Ç—É—Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –∫–ª–∞—Å—Ç–µ—Ä–∞.

---

## 7. –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

### 7.1. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ –ø–æ —à–∞—Ä–¥–∞–º

–ü–æ–ª—É—á–µ–Ω–∏–µ UUID –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑ —á–∞–Ω–∫–æ–≤:

```javascript
use config

var ticketsCollection = db.collections.findOne({ _id: "shopdb.tickets" })
var ticketsUUID = ticketsCollection.uuid

var chunksCount = db.chunks.find({ uuid: ticketsUUID }).count()
print("–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ chunks: " + chunksCount)
```

> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ ‚Äî **14**.

–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ –ø–æ —à–∞—Ä–¥–∞–º:

```javascript
db.chunks.aggregate([
  { $match: { uuid: ticketsUUID } },
  { $group: { _id: "$shard", count: { $sum: 1 } } },
  { $sort: { count: -1 } }
])
```

| –®–∞—Ä–¥ | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ (–¥–æ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏) | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ (–ø–æ—Å–ª–µ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏) |
|---|---|---|
| shard-replica-set-1 | 4 | 6 |
| shard-replica-set-2 | 4 | 4 |
| shard-replica-set-3 | 1 | 4 |

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–≤—à–∏—Ö —á–∞–Ω–∫–æ–≤:

```javascript
var migratedChunks = db.chunks.find({
  uuid: ticketsUUID,
  "history.1": { $exists: true }
}).count()
print("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–≤—à–∏—Ö chunks: " + migratedChunks)
```

> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** 9 —á–∞–Ω–∫–æ–≤ –±—ã–ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–æ–º –º–µ–∂–¥—É —à–∞—Ä–¥–∞–º–∏.

### 7.2. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ —à–∞—Ä–¥–∞–º

```javascript
use shopdb
db.tickets.getShardDistribution()
```

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —à–∞—Ä–¥–∞–º (getShardDistribution)*
>
![03_shard_distribution.png](../../screen/03_shard_distribution.png)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

| –®–∞—Ä–¥ | –î–æ–∫—É–º–µ–Ω—Ç—ã | –î–∞–Ω–Ω—ã–µ | % –æ—Ç –æ–±—â–µ–≥–æ –æ–±—ä—ë–º–∞ | –ß–∞–Ω–∫–∏ | Avg —Ä–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–∞ |
|---|---|---|---|---|---|
| shard-replica-set-1 | 32 321 | 5.01 MiB | 32.32% | 6 | 162 B |
| shard-replica-set-2 | 25 863 | 4.01 MiB | 25.86% | 4 | 162 B |
| shard-replica-set-3 | 41 816 | 6.49 MiB | 41.81% | 4 | 162 B |
| **–ò—Ç–æ–≥–æ** | **100 000** | **15.53 MiB** | **100%** | **14** | ‚Äî |

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è*
>
> ![–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è](screenshots/04_distribution_stats.png)

### 7.3. –í—ã–≤–æ–¥—ã –ø–æ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–µ

**–ö–ª—é—á —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è:** —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ –ø–æ–ª—é `user_id`.

**–ü—Ä–æ—Ü–µ—Å—Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏:**

- –ü–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è MongoDB —Å–æ–∑–¥–∞–ª **9 —á–∞–Ω–∫–æ–≤**.
- –û–ø–µ—Ä–∞—Ü–∏–∏ `sh.splitFind()` —Ä–∞–∑–±–∏–ª–∏ –∫—Ä—É–ø–Ω—ã–µ —á–∞–Ω–∫–∏, —É–≤–µ–ª–∏—á–∏–≤ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ **14**.
- –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–ª **9 —á–∞–Ω–∫–æ–≤** –º–µ–∂–¥—É —à–∞—Ä–¥–∞–º–∏.
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å —Å **4‚Äì4‚Äì1** –Ω–∞ **6‚Äì4‚Äì4**.

**–ê–Ω–∞–ª–∏–∑ –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏:**

–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—é —á–∞–Ω–∫–æ–≤, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Å—Ç–∞–ª–æ—Å—å –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–º (–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–æ ~16% –æ—Ç –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è 33.3%). –≠—Ç–æ –æ–±—É—Å–ª–æ–≤–ª–µ–Ω–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º —Ö–µ—à-—Ñ—É–Ω–∫—Ü–∏–∏ –∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–±–æ–ª—å—à–∏–º –æ–±—ä—ë–º–æ–º –¥–∞–Ω–Ω—ã—Ö (100 000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤). –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –æ–±—ä—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ –º–∏–ª–ª–∏–æ–Ω–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–Ω–µ—Ç –±–æ–ª–µ–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–º –±–ª–∞–≥–æ–¥–∞—Ä—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–º —Å–≤–æ–π—Å—Ç–≤–∞–º —Ö–µ—à-—Ñ—É–Ω–∫—Ü–∏–∏.

**–û—Ü–µ–Ω–∫–∞:** –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ù–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–∞.

---

## 8. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

### 8.1. –¢–µ—Å—Ç 1: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ PRIMARY-–Ω–æ–¥—ã –æ–¥–Ω–æ–≥–æ —à–∞—Ä–¥–∞

#### –°–æ—Å—Ç–æ—è–Ω–∏–µ –î–û –æ—Ç–∫–ª—é—á–µ–Ω–∏—è

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø–µ—Ä–≤–æ–π –Ω–æ–¥–µ Shard 1 –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞:

```bash
docker exec -it mongo-shard-1-rs-1 mongosh --port 27018
```

```javascript
rs.status()
```

–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∞-—Å–µ—Ç–∞ `shard-replica-set-1`:

| –ù–æ–¥–∞ | –†–æ–ª—å | –°–æ—Å—Ç–æ—è–Ω–∏–µ (health) |
|---|---|---|
| mongo-shard-1-rs-1 | SECONDARY | 1 (healthy) |
| mongo-shard-1-rs-2 | **PRIMARY** | 1 (healthy) |
| mongo-shard-1-rs-3 | SECONDARY | 1 (healthy) |

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –ë–î –¥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –Ω–æ–¥—ã*
>
![05_data_before_stop.png](../../screen/05_data_before_stop.png)

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç **–¥–æ** –æ—Ç–∫–ª—é—á–µ–Ω–∏—è:

```javascript
db.tickets.insertOne({
  ticket_id: 200000,
  user_id: 99999,
  amount: 12345,
  product: "–¢–µ—Å—Ç –î–û –æ—Ç–∫–ª—é—á–µ–Ω–∏—è",
  city: "–ú–æ—Å–∫–≤–∞",
  status: "pending",
  created_at: new Date("2025-02-07T12:00:00Z")
})
```

#### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ PRIMARY-–Ω–æ–¥—ã

–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å PRIMARY-–Ω–æ–¥–æ–π:

```bash
docker stop mongo-shard-1-rs-1
```

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ PRIMARY-–Ω–æ–¥—ã (docker stop)*
>
![06_primary_stopped.png](../../screen/06_primary_stopped.png)

#### –°–æ—Å—Ç–æ—è–Ω–∏–µ –ü–û–°–õ–ï –æ—Ç–∫–ª—é—á–µ–Ω–∏—è

–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å `rs.status()` —Å –æ—Å—Ç–∞–≤—à–µ–π—Å—è –Ω–æ–¥—ã:

```javascript
rs.status()
```

| –ù–æ–¥–∞ | –†–æ–ª—å | –°–æ—Å—Ç–æ—è–Ω–∏–µ (health) |
|---|---|---|
| mongo-shard-1-rs-1 | **(not reachable/healthy)** | 0 (down) |
| mongo-shard-1-rs-2 | **PRIMARY** | 1 (healthy) |
| mongo-shard-1-rs-3 | SECONDARY | 1 (healthy) |

> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –Ω–æ–¥–∞ `mongo-shard-1-rs-2` –æ—Å—Ç–∞–ª–∞—Å—å PRIMARY (–±—ã–ª–∞ –≤—ã–±—Ä–∞–Ω–∞ —Ä–∞–Ω–µ–µ). –ù–æ–¥–∞ `mongo-shard-1-rs-1` –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ `(not reachable/healthy)` —Å –æ—à–∏–±–∫–æ–π: `Error connecting to mongo-shard-1-rs-1:27018 :: Host not found`.

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

–î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç **–ø–æ—Å–ª–µ** –æ—Ç–∫–ª—é—á–µ–Ω–∏—è PRIMARY-–Ω–æ–¥—ã:

```javascript
db.tickets.insertOne({
  ticket_id: 200001,
  user_id: 88888,
  amount: 54321,
  product: "–¢–µ—Å—Ç –ü–û–°–õ–ï –æ—Ç–∫–ª—é—á–µ–Ω–∏—è PRIMARY",
  city: "–ö–∞–∑–∞–Ω—å",
  status: "delivered",
  created_at: new Date("2025-02-07T12:05:00Z")
})
```

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–¢–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è PRIMARY-–Ω–æ–¥—ã*
>
![07_insert_after_stop.png](../../screen/07_insert_after_stop.png)

> **–í—ã–≤–æ–¥:** –∑–∞–ø–∏—Å—å –∏ —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø–æ—Ç–µ—Ä—é –æ–¥–Ω–æ–π –Ω–æ–¥—ã.

#### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–¥—ã

```bash
docker start mongo-shard-1-rs-1
sleep 15
```

–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `rs.status()`:

| –ù–æ–¥–∞ | –†–æ–ª—å | –°–æ—Å—Ç–æ—è–Ω–∏–µ (health) |
|---|---|---|
| mongo-shard-1-rs-1 | SECONDARY | 1 (healthy) |
| mongo-shard-1-rs-2 | **PRIMARY** | 1 (healthy) |
| mongo-shard-1-rs-3 | SECONDARY | 1 (healthy) |

> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –Ω–æ–¥–∞ `mongo-shard-1-rs-1` —É—Å–ø–µ—à–Ω–æ –≤–µ—Ä–Ω—É–ª–∞—Å—å –≤ —Ä–µ–ø–ª–∏–∫–∞-—Å–µ—Ç –≤ —Ä–æ–ª–∏ SECONDARY –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å —Å PRIMARY.

---

### 8.2. –¢–µ—Å—Ç 2: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ü–µ–ª–æ–≥–æ —à–∞—Ä–¥–∞

#### –°–æ—Å—Ç–æ—è–Ω–∏–µ –î–û –æ—Ç–∫–ª—é—á–µ–Ω–∏—è

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —à–∞—Ä–¥–∞*
>
![08_docs_before_shard_stop.png](../../screen/08_docs_before_shard_stop.png)

#### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –Ω–æ–¥ Shard 2

```bash
docker stop mongo-shard-2-rs-1 mongo-shard-2-rs-2 mongo-shard-2-rs-3
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

**–ó–∞–ø—Ä–æ—Å—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º shard key (user_id):**

```javascript
db.tickets.find({ user_id: 1 }).limit(3)
db.tickets.find({ user_id: 5000 }).limit(3)
db.tickets.find({ user_id: 9999 }).limit(3)
```

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ shard key –ø—Ä–∏ –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–º —à–∞—Ä–¥–µ*
>
![09_queries_shard_down.png](../../screen/09_queries_shard_down.png)

> ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –∑–∞–ø—Ä–æ—Å—ã –ø–æ `user_id`, –¥–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã—Ö —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –Ω–∞ —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —à–∞—Ä–¥–∞—Ö (shard-1, shard-3), –≤—ã–ø–æ–ª–Ω–µ–Ω—ã **—É—Å–ø–µ—à–Ω–æ**.

**–ó–∞–ø—Ä–æ—Å –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ (scatter-gather):**

```javascript
db.tickets.find().limit(10)
```

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–û—à–∏–±–∫–∞ –ø—Ä–∏ scatter-gather –∑–∞–ø—Ä–æ—Å–µ —Å –æ—Ç–∫–ª—é—á—ë–Ω–Ω—ã–º —à–∞—Ä–¥–æ–º*
>
![10_scatter_gather_error.png](../../screen/10_scatter_gather_error.png)

> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –∑–∞–ø—Ä–æ—Å –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è shard key —Ç—Ä–µ–±—É–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –∫–æ –≤—Å–µ–º —à–∞—Ä–¥–∞–º (scatter-gather) –∏ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è **–æ—à–∏–±–∫–æ–π**, —Ç–∞–∫ –∫–∞–∫ shard-2 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

#### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞—Ä–¥–∞

```bash
docker start mongo-shard-2-rs-1 mongo-shard-2-rs-2 mongo-shard-2-rs-3
```

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–î–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —à–∞—Ä–¥–∞ ‚Äî –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç*
>
![11_shard_restored.png](../../screen/11_shard_restored.png)

> ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –Ω–æ–¥ —à–∞—Ä–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è. –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫.

### 8.3. –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

| –°—Ü–µ–Ω–∞—Ä–∏–π | –†–µ–∑—É–ª—å—Ç–∞—Ç | –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö |
|---|---|---|
| –û—Ç–∫–ª—é—á–µ–Ω–∏–µ 1 –Ω–æ–¥—ã (PRIMARY) –∏–∑ Replica Set | PRIMARY –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∏–∑–±–∏—Ä–∞–µ—Ç—Å—è | –ü–æ–ª–Ω–∞—è (—á—Ç–µ–Ω–∏–µ + –∑–∞–ø–∏—Å—å) |
| –í–æ–∑–≤—Ä–∞—Ç –Ω–æ–¥—ã –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∫ SECONDARY | –ü–æ–ª–Ω–∞—è |
| –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ–≥–æ —à–∞—Ä–¥–∞ (3 –Ω–æ–¥—ã) | –î–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —à–∞—Ä–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã | –ß–∞—Å—Ç–∏—á–Ω–∞—è (—Ç–æ–ª—å–∫–æ –ø–æ shard key –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞—Ä–¥–∞—Ö) |
| Scatter-gather –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–º —à–∞—Ä–¥–µ | –û—à–∏–±–∫–∞ |–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞—Ä–¥–∞ | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ | –ü–æ–ª–Ω–∞—è |

---

## 9. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### 9.1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∫–ª–∞—Å—Ç–µ—Ä–∞ (root):**

```javascript
use admin

db.createUser({
  user: "admin",
  pwd: "admin123",
  roles: [
    { role: "root", db: "admin" }
  ]
})
```

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è admin*
>
![12_create_admin.png](../../screen/12_create_admin.png)

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö `shopdb`:**

```javascript
use shopdb

// –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ
db.createUser({
  user: "reader",
  pwd: "reader123",
  roles: [
    { role: "read", db: "shopdb" }
  ]
})

// –ß—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å
db.createUser({
  user: "writer",
  pwd: "writer123",
  roles: [
    { role: "readWrite", db: "shopdb" }
  ]
})
```

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π reader –∏ writer*
>
![13_create_reader_writer.png](../../screen/13_create_reader_writer.png)

**–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ë–î `shopdb`:**

```javascript
db.createUser({
  user: "dbadmin",
  pwd: "dbadmin123",
  roles: [
    { role: "dbAdmin", db: "shopdb" },
    { role: "readWrite", db: "shopdb" }
  ]
})
```

**–ê–Ω–∞–ª–∏—Ç–∏–∫ (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ):**

```javascript
db.createUser({
  user: "analyst",
  pwd: "analyst123",
  roles: [
    { role: "read", db: "shopdb" }
  ]
})
```

### 9.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```javascript
db.getUsers()
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–∞–∑—ã `shopdb`:

| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | –ë–∞–∑–∞ | –†–æ–ª–∏ | –ú–µ—Ö–∞–Ω–∏–∑–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ |
|---|---|---|---|
| admin | admin | root | SCRAM-SHA-1, SCRAM-SHA-256 |
| reader | shopdb | read | SCRAM-SHA-1, SCRAM-SHA-256 |
| writer | shopdb | readWrite | SCRAM-SHA-1, SCRAM-SHA-256 |
| dbadmin | shopdb | dbAdmin, readWrite | SCRAM-SHA-1, SCRAM-SHA-256 |
| analyst | shopdb | read | SCRAM-SHA-1, SCRAM-SHA-256 |

### 9.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `admin` (root)

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π:

```bash
docker exec -it mongos-router mongosh -u admin -p admin123 --authenticationDatabase admin
```

–í—ã–ø–æ–ª–Ω–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏:

```javascript
use shopdb

// –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
db.tickets.find().limit(3)

// –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö
db.tickets.insertOne({
  ticket_id: 300001,
  user_id: 12345,
  amount: 5000,
  product: "–¢–µ—Å—Ç –∞–¥–º–∏–Ω–∞",
  city: "–ú–æ—Å–∫–≤–∞",
  status: "pending"
})

// –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
db.tickets.createIndex({ city: 1 })

// –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
db.adminCommand({ listShards: 1 })
```

> üì∑ **–°–∫—Ä–∏–Ω—à–æ—Ç:** *–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ admin ‚Äî –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω—ã*
>
![14_admin_check.png](../../screen/14_admin_check.png)

**–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `admin`:**

| –û–ø–µ—Ä–∞—Ü–∏—è | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|---|---|
| –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö | –£—Å–ø–µ—à–Ω–æ |
| –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö | –£—Å–ø–µ—à–Ω–æ |
| –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ | –£—Å–ø–µ—à–Ω–æ |
| –î–æ—Å—Ç—É–ø –∫ `config` –±–∞–∑–µ | –£—Å–ø–µ—à–Ω–æ |
| –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ `listShards`, `listDatabases` | –£—Å–ø–µ—à–Ω–æ |

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –∫–æ–º–∞–Ω–¥–∞ `sh.status()` –≤—ã–¥–∞–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É (`TypeError: e._id.startsWith is not a function`) ‚Äî —ç—Ç–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–π –±–∞–≥ mongosh. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ `db.adminCommand({listShards:1})` –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—è –ø–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

### 9.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `reader` (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ)

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:

```bash
docker exec -it mongos-router mongosh -u reader -p reader123 --authenticationDatabase shopdb
```

–í—ã–ø–æ–ª–Ω–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã:

```javascript
use shopdb

// –ß—Ç–µ–Ω–∏–µ ‚Äî —É—Å–ø–µ—à–Ω–æ
db.tickets.find({ user_id: 5000 }).limit(3)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `reader` —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è –≤ –±–∞–∑–µ `shopdb`. –ó–∞–ø–∏—Å—å –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ‚Äî –ø—Ä–∞–≤–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã —Ä–æ–ª—å—é `read`.

---

## 10. –í—ã–≤–æ–¥—ã

–í —Ö–æ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–π —Ä–∞–±–æ—Ç—ã –±—ã–ª–∏ —Ä–µ—à–µ–Ω—ã –≤—Å–µ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:

1. **–†–∞–∑–≤—ë—Ä–Ω—É—Ç —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä MongoDB** –∏–∑ 13 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ Docker: 3 Config Server, 9 –Ω–æ–¥ –¥–∞–Ω–Ω—ã—Ö (3 —à–∞—Ä–¥–∞ √ó 3 —Ä–µ–ø–ª–∏–∫–∏), 1 Mongos Router.

2. **–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ** –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `shopdb.tickets` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞ –ø–æ –ø–æ–ª—é `user_id`. –î–∞–Ω–Ω—ã–µ (100 000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤) —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ —Ç—Ä—ë–º —à–∞—Ä–¥–∞–º.

3. **–ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞.** –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–ª 9 —á–∞–Ω–∫–æ–≤. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö: 32.32% / 25.86% / 41.81% ‚Äî –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–±—ä—ë–º–∞.

4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:**
  - –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ PRIMARY-–Ω–æ–¥—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∏–∑–±—Ä–∞–Ω–∏–µ, –∫–ª–∞—Å—Ç–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É.
  - –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ —Ü–µ–ª–æ–≥–æ —à–∞—Ä–¥–∞ –∑–∞–ø—Ä–æ—Å—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º shard key –∫ –¥—Ä—É–≥–∏–º —à–∞—Ä–¥–∞–º –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å; scatter-gather –∑–∞–ø—Ä–æ—Å—ã –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –æ—à–∏–±–∫–æ–π.
  - –ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–æ–¥—ã/—à–∞—Ä–¥–∞ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è.

5. **–ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** —Å —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø—Ä–∞–≤: —Å–æ–∑–¥–∞–Ω–æ 5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—è–º–∏ `root`, `read`, `readWrite`, `dbAdmin`. –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞.
