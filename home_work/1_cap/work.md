# Анализ баз данных в контексте CAP теоремы

## Введение в CAP теорему

CAP теорема (также известная как теорема Брюера) описывает фундаментальные ограничения распределенных систем. Согласно этой теореме, любая распределенная система может одновременно обеспечить только два из трех следующих свойств:

- **Consistency (Согласованность)** — все узлы системы видят одни и те же данные в один и тот же момент времени
- **Availability (Доступность)** — каждый запрос получает ответ о успешном или неуспешном выполнении
- **Partition Tolerance (Устойчивость к разделению)** — система продолжает работать несмотря на потерю или задержку сообщений между узлами

## MongoDB

**Категория: CP (Consistency + Partition Tolerance) с возможностью настройки**

MongoDB представляет собой документо-ориентированную NoSQL базу данных, которая изначально проектировалась как распределенная система. В стандартной конфигурации с replica set MongoDB демонстрирует характеристики CP-системы.

### Почему CP?

При возникновении сетевого разделения MongoDB жертвует доступностью в пользу согласованности. Это проявляется следующим образом:

- Replica set работает по принципу выборов primary узла через механизм Raft-подобного консенсуса
- При потере связи с primary узлом система проводит новые выборы
- В момент выборов записи становятся недоступны (жертвуем Availability)
- Read операции могут быть настроены через read concern, но по умолчанию читается из primary для строгой согласованности

### Гибкость настройки

Важная особенность MongoDB — возможность тонкой настройки поведения через write concern и read concern. При необходимости можно сдвинуть систему ближе к AP-модели, используя:
- `w:1` для write concern (не ждать подтверждения от реплик)
- `readPreference: secondary` с `readConcern: local`

Однако это приводит к eventual consistency, что означает временное отступление от строгой согласованности.

---

## MSSQL (Microsoft SQL Server)

**Категория: CA (Consistency + Availability)**

Microsoft SQL Server — это классическая реляционная СУБД, спроектированная для работы в рамках одного датацентра или тесно связанных узлов.

### Почему CA?

MSSQL приоритизирует ACID-транзакции и немедленную согласованность данных:

- Поддерживает строгую транзакционную модель с isolation levels
- Обеспечивает немедленную согласованность через механизмы блокировок и journaling
- В стандартной конфигурации предполагает отсутствие серьезных сетевых разделений

### Ограничения при network partition

При возникновении настоящего network partition MSSQL демонстрирует CA-характеристики:

- В Always On Availability Groups при потере кворума система останавливает операции записи
- Система предпочитает стать недоступной, чем нарушить согласованность данных
- Реплики в разных датацентрах могут потерять синхронизацию, но primary не примет изменения без подтверждения

Современные решения вроде Always On AG добавляют элементы распределенности, но фундаментально архитектура остается CA-ориентированной. MSSQL не проектировался для сценариев с регулярными network partitions между географически распределенными узлами.

---

## Cassandra

**Категория: AP (Availability + Partition Tolerance)**

Apache Cassandra — распределенная NoSQL база данных, изначально разработанная для работы в условиях eventual consistency и высокой отказоустойчивости.

### Почему AP?

Cassandra спроектирована для обеспечения максимальной доступности даже в условиях сетевых разделений:

- Архитектура без единой точки отказа (masterless architecture)
- Каждый узел может принимать запросы на чтение и запись
- При network partition каждая часть кластера продолжает работать независимо
- Используется eventual consistency — данные со временем синхронизируются через anti-entropy механизмы

### Механизмы работы

Cassandra использует несколько ключевых техник для достижения AP-свойств:

- **Tunable consistency**: можно настроить consistency level (ONE, QUORUM, ALL), но по умолчанию система выбирает availability
- **Hinted handoff**: если узел недоступен, другой узел сохраняет данные для него и передаст при восстановлении связи
- **Read repair**: при чтении обнаруживаются расхождения между репликами и исправляются
- **Gossip protocol**: узлы обмениваются информацией о состоянии кластера

При использовании consistency level = QUORUM можно приблизиться к CP-поведению, но базовая архитектура все равно оптимизирована для AP-сценариев.

---

## Сравнительная таблица

| База данных | CAP категория | Приоритет | Типичный use case |
|-------------|---------------|-----------|-------------------|
| **MongoDB** | CP (настраиваемая) | Согласованность при разделении сети | Приложения, требующие строгой консистентности с возможностью горизонтального масштабирования |
| **MSSQL** | CA | Транзакционная целостность и доступность | Enterprise-приложения с критичными транзакциями в пределах одного ЦОД |
| **Cassandra** | AP | Максимальная доступность и отказоустойчивость | Системы с огромным масштабом, где eventual consistency приемлема (аналитика, логи, time-series) |

---

## Заключение

Выбор базы данных в контексте CAP теоремы должен основываться на требованиях конкретного приложения:

- Если критична строгая консистентность в распределенной среде — MongoDB предоставляет хороший баланс
- Для традиционных enterprise-систем с ACID-транзакциями — MSSQL остается надежным выбором
- Когда требуется максимальная доступность и система может работать с eventual consistency — Cassandra показывает лучшие результаты

Стоит помнить, что CAP теорема описывает крайние случаи (network partition), которые в реальности случаются относительно редко. Однако понимание этих фундаментальных компромиссов критически важно для проектирования надежных распределенных систем.